generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =======================
// ENUMS para Estandarizaci贸n
// =======================

enum RegistrationMethod {
  GOOGLE
  FACEBOOK
  EMAIL
  TWITTER
}

enum AgeUnit {
  YEARS
  MONTHS
}

enum Coin {
  BOLIVIANOS
  DOLLARS
}

enum PetStatus {
  LOST // P茅rdida activa
  FOUND // Encontrada, no adoptada/reunida
  ADOPTION // En proceso de adopci贸n
  REUNITED // Devuelta al due帽o
}

enum Gender {
  MALE
  FEMALE
  UNKNOWN
}

// =======================
// CORE MODELS (Usuarios, Roles)
// =======================

/// Representa a un usuario de la aplicaci贸n.
model User {
  id                  String    @id @default(uuid())
  name                String
  email               String    @unique
  emailVerified       DateTime?
  image               String?
  accounts            Account[] // Puede tener m煤ltiples cuentas (Google, Facebook, etc)
  phone               String?
  locationDescription String? // Ubicaci贸n general  

  //  CAMPOS PARA NOTIFICACIONES POR GEOLOCALIZACIN 
  // Preferencia del usuario
  acceptNotifications  Boolean  @default(true)
  // Coordenadas del centro de su zona de inter茅s para alertas
  notificationLat      Decimal? @db.Decimal(10, 8)
  notificationLon      Decimal? @db.Decimal(11, 8)
  // Radio de b煤squeda en kil贸metros
  notificationRadiusKm Decimal? @db.Decimal(6, 2)

  // Relaciones
  sightings     Sighting[] // Avistamientos reportados
  pets          Pet[] // Mascotas registradas por el usuario (due帽o/reportante)
  walkerProfile Walker? // Perfil de paseador (relaci贸n 1:1)
  userRoles     UserRole[]
  favorites     Favorite[] // Mascotas favoritas del usuario

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([acceptNotifications])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String // "google" o "facebook"
  providerAccountId String // ID del usuario en Google o Facebook
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

/// Define los roles que puede tener un usuario (ej: Admin, User, Reporter).
model Role {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?

  // Relaciones
  userRoles UserRole[]

  @@index([name])
}

/// Tabla de uni贸n para la relaci贸n muchos a muchos entre User y Role.
model UserRole {
  id     Int    @id @default(autoincrement())
  userId String
  roleId String

  // Relaciones: Cascade para mantener la integridad si se elimina el User/Role
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// =======================
// PETS & RELATED MODELS (Mascotas, Razas, Avistamientos, Adopciones)
// =======================

/// Cat谩logo de especies (ej: perro, gato).
model Species {
  id   String @id @default(uuid())
  name String @unique

  // Relaciones
  pets   Pet[]
  breeds Breed[]
}

/// Cat谩logo de razas (ej: Labrador, Persa).
model Breed {
  id        String  @id @default(uuid())
  name      String
  speciesId String?

  // Relaciones
  pets    Pet[]
  // SetNull: Si se elimina una especie, la raza se queda sin especie asociada (aunque no deber铆a ocurrir)
  species Species? @relation(fields: [speciesId], references: [id], onDelete: SetNull)

  @@unique([name, speciesId])
  @@index([speciesId])
}

/// Representa una mascota registrada (perdida o para adopci贸n).
model Pet {
  id          String    @id @default(uuid())
  name        String?
  age         Int?
  ageUnit     AgeUnit   @default(YEARS)
  color       String?
  gender      Gender? // Usando el enum Gender
  description String?
  status      PetStatus @default(LOST) // Usando el enum PetStatus

  //  UBICACIN EXACTA DE PRDIDA/HALLAZGO 
  lostDate            DateTime @db.Date
  lostLocationLat     Decimal  @db.Decimal(10, 8) // Latitud de la p茅rdida (OBLIGATORIO)
  lostLocationLon     Decimal  @db.Decimal(11, 8) // Longitud de la p茅rdida (OBLIGATORIO)
  lostLocationDetails String? // Texto descriptivo del lugar

  rewardAmount Decimal? @db.Decimal(10, 2) // Recompensa
  rewardCoin   Coin?    @default(BOLIVIANOS)

  // Claves For谩neas
  ownerId   String?
  speciesId String?
  breedId   String?

  // Relaciones
  adoptions   Adoption[]
  sightings   Sighting[]
  images      PetImage[]
  favoritedBy Favorite[] // Usuarios que han marcado esta mascota como favorita

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  species Species? @relation(fields: [speciesId], references: [id], onDelete: SetNull)
  breed   Breed?   @relation(fields: [breedId], references: [id], onDelete: SetNull)
  owner   User?    @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([speciesId])
  @@index([breedId])
  @@index([ownerId])
  @@index([status])
  @@index([lostLocationLat, lostLocationLon]) // ndice compuesto para b煤squedas geoespaciales
}

/// Im谩genes asociadas a una mascota.
model PetImage {
  id        String  @id @default(uuid())
  petId     String
  url       String
  isPrimary Boolean @default(false)

  // Relaci贸n: Cascade, si la mascota se elimina, sus im谩genes tambi茅n.
  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
}

/// Reporte de un avistamiento de una mascota.
model Sighting {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Timestamptz(6)
  // Ubicaci贸n del avistamiento (coordenadas)
  sightingLat Decimal  @db.Decimal(10, 8)
  sightingLon Decimal  @db.Decimal(11, 8)

  // Campo textual reincorporado
  locationDescription String?

  description String?
  photoUrl    String?

  // Claves For谩neas
  petId      String?
  reporterId String?

  // Relaciones
  pet      Pet?  @relation(fields: [petId], references: [id], onDelete: SetNull)
  reporter User? @relation(fields: [reporterId], references: [id], onDelete: SetNull)

  @@index([petId])
  @@index([reporterId])
  @@index([date])
  @@index([sightingLat, sightingLon])
}

/// Procesos de adopci贸n de mascotas.
model Adoption {
  id           String  @id @default(uuid())
  petId        String  @unique // Una mascota solo puede estar en un proceso de adopci贸n
  requirements String?
  contactInfo  String?

  // Relaci贸n: Cascade, si el registro de la mascota se elimina, el proceso de adopci贸n termina.
  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
}

/// Relaciona a un usuario con una mascota que ha marcado como favorita.
model Favorite {
  userId    String
  petId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  pet  Pet  @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@id([userId, petId])
  @@index([userId])
  @@index([petId])
}

// =======================
// SERVICE & REGIONAL MODELS (Paseadores, Regiones)
// =======================

/// Perfil de un paseador de mascotas.
model Walker {
  id       String  @id @default(uuid())
  userId   String  @unique // Relaci贸n 1:1 con el User
  regionId String? // Asociaci贸n a una regi贸n (para facilitar b煤squedas)

  experience   String?
  hourlyRate   Decimal? @db.Decimal(5, 2)
  availability String?
  coverageArea String?

  // Relaciones
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  region Region? @relation(fields: [regionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([regionId])
}

/// Define las 谩reas geogr谩ficas donde opera la aplicaci贸n.
model Region {
  id               String    @id @default(uuid())
  countryCode      String
  countryName      String
  department       String
  city             String
  isActive         Boolean?  @default(false) //  CLAVE: Inicialmente 'false' para nuevas 谩reas, 'true' para Tarija.
  activationDate   DateTime? @db.Date
  latitude         Decimal?  @db.Decimal(10, 8)
  longitude        Decimal?  @db.Decimal(11, 8)
  coverageRadiusKm Decimal?  @db.Decimal(6, 2) // Usar este radio para definir el 谩rea de restricci贸n

  // Relaciones
  expansions Expansion[]
  walkers    Walker[]

  @@unique([countryCode, city])
  @@index([isActive])
}

/// Registro hist贸rico de cu谩ndo se activ贸 una regi贸n.
model Expansion {
  id            String   @id @default(uuid())
  regionId      String
  expansionDate DateTime @db.Date

  // Relaci贸n
  region Region @relation(fields: [regionId], references: [id], onDelete: Cascade)

  @@index([regionId])
}
